import os
import openai
import json
import requests
import base64
from PIL import Image
from io import BytesIO
import fitz  # PyMuPDF –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PDF

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª—é—á OpenAI –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
openai.api_key = os.getenv("OPENAI_API_KEY")
if not openai.api_key:
    raise ValueError("OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

def get_analysis_from_chatgpt(recognized_text: str) -> str:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ OpenAI ChatCompletion –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
    –§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ (prompt) –º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞.
    """
    prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –∫—Ä–æ–≤–∏.

–¢—Ä–µ–±—É–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
- –û–±—â–∏–π –≤—ã–≤–æ–¥.
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é.
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.

–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞:
{recognized_text}
"""
    try:
        response = openai.Client().chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "–¢—ã —è–≤–ª—è–µ—à—å—Å—è —ç–∫—Å–ø–µ—Ä—Ç–æ–º –≤ –æ–±–ª–∞—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑–∞ –∫—Ä–æ–≤–∏. –î–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=800
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ ChatGPT: {e}"

def get_analysis_from_chatgpt_vision(file_bytes: bytes, file_name: str) -> str:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ GPT-4 Vision API, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ –∫—Ä–æ–≤–∏
    –∏ –ø—Ä–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤—ã–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
        if file_name.lower().endswith('.pdf'):
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ PDF
            pdf_document = fitz.open(stream=file_bytes, filetype="pdf")
            
            # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã PDF –≤ —Å–ø–∏—Å–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            images_base64 = []
            for page_num in range(len(pdf_document)):
                page = pdf_document[page_num]
                # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
                pix = page.get_pixmap(matrix=fitz.Matrix(2, 2))
                img_data = pix.tobytes("jpeg")
                base64_image = base64.b64encode(img_data).decode('utf-8')
                images_base64.append(base64_image)
            
            pdf_document.close()
            
            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
            print(f"Debug - PDF –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –ø–æ–ª—É—á–µ–Ω–æ {len(images_base64)} —Å—Ç—Ä–∞–Ω–∏—Ü")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            messages = [
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": "–ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ –∫—Ä–æ–≤–∏ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–æ–≥–æ –≤ —Ç—Ä–µ–±—É–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{img}"
                            }
                        }
                    ]
                }
                for i, img in enumerate(images_base64)
            ]
        else:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            image = Image.open(BytesIO(file_bytes))
            if image.mode != 'RGB':
                image = image.convert('RGB')
            buffer = BytesIO()
            image.save(buffer, format="JPEG")
            base64_image = base64.b64encode(buffer.getvalue()).decode('utf-8')
            
            messages = [
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": "–ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ –∫—Ä–æ–≤–∏ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–æ–≥–æ –≤ —Ç—Ä–µ–±—É–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{base64_image}"
                            }
                        }
                    ]
                }
            ]
        
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –∞–Ω–∞–ª–∏–∑–æ–º –∫—Ä–æ–≤–∏
        # –î–ª—è PDF –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        check_image = base64_image if not file_name.lower().endswith('.pdf') else images_base64[0]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
        print(f"Debug - –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É, —Ä–∞–∑–º–µ—Ä base64: {len(check_image)}")
        
        validation_response = openai.Client().chat.completions.create(
            model="gpt-4-turbo",
            messages=[
                {
                    "role": "system",
                    "content": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –∞–Ω–∞–ª–∏–∑–∞–º. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–æ–º –∫—Ä–æ–≤–∏.
                    
                    –≠—Ç–æ –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏, –µ—Å–ª–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤:
                    - –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≥–µ–º–æ–≥–ª–æ–±–∏–Ω–∞, —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–æ–≤, –ª–µ–π–∫–æ—Ü–∏—Ç–æ–≤
                    - –ë–∏–æ—Ö–∏–º–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∫—Ä–æ–≤–∏
                    - –ö–æ–∞–≥—É–ª–æ–≥—Ä–∞–º–º–∞
                    - –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏
                    - –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∫—Ä–æ–≤–∏
                    
                    –û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ '–¥–∞' –∏–ª–∏ '–Ω–µ—Ç'. –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å –æ–¥–∏–Ω –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∫—Ä–æ–≤–∏ - –æ—Ç–≤–µ—Ç '–¥–∞'."""
                },
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": """–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ï—Å—Ç—å –ª–∏ –Ω–∞ –Ω—ë–º —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞ –∫—Ä–æ–≤–∏?
                            –î–∞–∂–µ –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –æ—á–µ–Ω—å —á–µ—Ç–∫–æ–µ, –Ω–æ —Ç—ã –≤–∏–¥–∏—à—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ –ª—é–±—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∫—Ä–æ–≤–∏ - –æ—Ç–≤–µ—Ç—å '–¥–∞'.
                            –û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: '–¥–∞' –∏–ª–∏ '–Ω–µ—Ç'."""
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{check_image}"
                            }
                        }
                    ]
                }
            ],
            max_tokens=10
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
        print(f"Debug - –û—Ç–≤–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {validation_response.choices[0].message.content}")
        
        is_blood_test = validation_response.choices[0].message.content.strip().lower()
        
        if is_blood_test != "–¥–∞":
            return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑–æ–º –∫—Ä–æ–≤–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏."
        
        # –î–ª—è PDF —Ñ–∞–π–ª–æ–≤ –±—É–¥–µ–º —Å–æ–±–∏—Ä–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
        all_results = []
        
        # –ï—Å–ª–∏ —ç—Ç–æ –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏, –ø–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        if file_name.lower().endswith('.pdf'):
            for page_num, img in enumerate(images_base64):
                response = openai.Client().chat.completions.create(
                    model="gpt-4-turbo",
                    messages=[
                        {
                            "role": "system",
                            "content": """–í–ê–ñ–ù–û: –ü–µ—Ä–µ—á–∏—Å–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ –∫—Ä–æ–≤–∏.
                            
                            –§–æ—Ä–º–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è (–æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π):
                            [–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å]: [–ó–Ω–∞—á–µ–Ω–∏–µ] [–ï–¥.–∏–∑–º.]
                            
                            –ü—Ä–∏–º–µ—Ä:
                            –ì–µ–º–æ–≥–ª–æ–±–∏–Ω: 125 –≥/–ª
                            –õ–µ–π–∫–æ—Ü–∏—Ç—ã: 11.2 10^9/–ª
                            
                            –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –¥—Ä—É–≥–∏—Ö –¥–∞–Ω–Ω—ã—Ö, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫.
                            –ü—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π, –ø–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ."""
                        },
                        {
                            "role": "user",
                            "content": [
                                {
                                    "type": "text",
                                    "text": f"–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page_num + 1}. –í—ã–ø–∏—à–∏ –≤—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ –∫—Ä–æ–≤–∏ –æ–¥–Ω–∏–º —Å–ø–∏—Å–∫–æ–º."
                                },
                                {
                                    "type": "image_url",
                                    "image_url": {
                                        "url": f"data:image/jpeg;base64,{img}"
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens=1000
                )
                
                page_result = response.choices[0].message.content.strip()
                if page_result:  # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ –ø—É—Å—Ç–æ–π
                    all_results.append(f"\n–°–¢–†–ê–ù–ò–¶–ê {page_num + 1}:\n{page_result}")
            
            # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
            return "\n".join(all_results)
        else:
            # –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–µ–∂–Ω—é—é –ª–æ–≥–∏–∫—É
            response = openai.Client().chat.completions.create(
                model="gpt-4-turbo",
                messages=[
                    {
                        "role": "system",
                        "content": """–í–ê–ñ–ù–û: –ü–µ—Ä–µ—á–∏—Å–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ –∫—Ä–æ–≤–∏.
                        
                        –§–æ—Ä–º–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è (–æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π):
                        [–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å]: [–ó–Ω–∞—á–µ–Ω–∏–µ] [–ï–¥.–∏–∑–º.]
                        
                        –ü—Ä–∏–º–µ—Ä:
                        –ì–µ–º–æ–≥–ª–æ–±–∏–Ω: 125 –≥/–ª
                        –õ–µ–π–∫–æ—Ü–∏—Ç—ã: 11.2 10^9/–ª
                        
                        –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –¥—Ä—É–≥–∏—Ö –¥–∞–Ω–Ω—ã—Ö, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫.
                        –ü—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π, –ø–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ."""
                    }
                ] + messages,
                max_tokens=1000
            )
            
            analysis_result = response.choices[0].message.content
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            return analysis_result

    except Exception as e:
        print(f"Debug - Error details: {str(e)}")  # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ GPT-4 Vision: {e}" 

def get_nutrition_recommendations(analysis_text: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–æ–≤
    """
    try:
        print(f"Debug - Sending analysis for recommendations: {analysis_text[:100]}...")
        response = openai.Client().chat.completions.create(
            model="gpt-4-turbo",
            messages=[
                {
                    "role": "system",
                    "content": """–¢—ã –æ–ø—ã—Ç–Ω—ã–π –¥–∏–µ—Ç–æ–ª–æ–≥. –°–æ—Å—Ç–∞–≤—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é 
                    –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–æ–≤ –∫—Ä–æ–≤–∏. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –∏ —Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏.
                    
                    –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (—Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π —ç—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ):
                    
                    ü•ó –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –ü–†–û–î–£–ö–¢–´
                    
                    ‚Ä¢ [—ç–º–æ–¥–∑–∏] [–ø—Ä–æ–¥—É–∫—Ç] - [–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]
                    ‚Ä¢ [—ç–º–æ–¥–∑–∏] [–ø—Ä–æ–¥—É–∫—Ç] - [–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]
                    
                    ‚õîÔ∏è –ü–†–û–î–£–ö–¢–´ –ö –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Æ
                    
                    ‚Ä¢ [—ç–º–æ–¥–∑–∏] [–ø—Ä–æ–¥—É–∫—Ç] - [–ø—Ä–∏—á–∏–Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è]
                    ‚Ä¢ [—ç–º–æ–¥–∑–∏] [–ø—Ä–æ–¥—É–∫—Ç] - [–ø—Ä–∏—á–∏–Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è]
                    
                    ‚è∞ –†–ï–ñ–ò–ú –ü–ò–¢–ê–ù–ò–Ø
                    
                    ‚Ä¢ [—ç–º–æ–¥–∑–∏] [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è]
                    ‚Ä¢ [—ç–º–æ–¥–∑–∏] [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è]
                    
                    ÔøΩÔøΩ –í–ê–ñ–ù–´–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø
                    
                    ‚Ä¢ [—ç–º–æ–¥–∑–∏] [–≤–∞–∂–Ω–æ–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ]
                    ‚Ä¢ [—ç–º–æ–¥–∑–∏] [–≤–∞–∂–Ω–æ–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ]
                    
                    –ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
                    1. –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø–∏—à–∏ –ó–ê–ì–õ–ê–í–ù–´–ú–ò –±—É–∫–≤–∞–º–∏ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    2. –ù–µ –¥–æ–±–∞–≤–ª—è–π –¥–≤–æ–µ—Ç–æ—á–∏—è –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
                    3. –û—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    4. –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —ç–º–æ–¥–∑–∏:
                       - –ü—Ä–æ–¥—É–∫—Ç—ã: ü•© ü•ë ü•ï üçé ü•¶ üçÖ üêü ü•ú ü•õ üçó
                       - –î–µ–π—Å—Ç–≤–∏—è: ‚¨ÜÔ∏è ‚¨áÔ∏è ‚û°Ô∏è üîÑ
                       - –°–æ—Å—Ç–æ—è–Ω–∏—è: ‚úÖ ‚ö†Ô∏è ‚ùå
                    5. –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –Ω–∞—á–∏–Ω–∞–π —Å '‚Ä¢ '"""
                },
                {
                    "role": "user",
                    "content": f"""–ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–æ–≤ –∫—Ä–æ–≤–∏ —Å–æ—Å—Ç–∞–≤—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ 
                    —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é —Å —ç–º–æ–¥–∑–∏:

                    {analysis_text}"""
                }
            ],
            max_tokens=1000
        )
        print("Debug - Got response from GPT")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ü–µ
        recommendations = response.choices[0].message.content
        return recommendations + "\n\n‚ö†Ô∏è –í–ê–ñ–ù–û: _–î–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–æ—Å—è—Ç –æ–±—â–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤–∞—à–∏–º –ª–µ—á–∞—â–∏–º –≤—Ä–∞—á–æ–º._"
    except Exception as e:
        print(f"Debug - Error in get_nutrition_recommendations: {str(e)}")
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {e}" 